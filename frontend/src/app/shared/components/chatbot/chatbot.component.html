<!-- Floating Chat Widget Container -->
<ng-container *ngIf="!isDismissed">
    <!-- Proactive Callout Bubble -->
    <div class="chat-callout animate-in fade-in slide-in-from-bottom-2 duration-500" *ngIf="showCallout && !isOpen"
        @popIn>
        <button
            class="absolute -top-2 -right-2 w-5 h-5 bg-slate-200 text-slate-600 rounded-full flex items-center justify-center text-[10px] hover:bg-slate-300 transition-colors"
            (click)="dismissCallout($event)">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <p class="m-0 text-slate-700 text-xs font-bold leading-relaxed">
            Hi! üëã Have a health question? I'm here to help you find doctors or check symptoms!
        </p>
    </div>

    <!-- Floating Chat Button -->
    <div class="fixed bottom-24 right-4 md:bottom-5 md:right-5 bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-4 md:px-6 md:py-3.5 rounded-full cursor-pointer flex items-center gap-0 md:gap-3 shadow-lg shadow-emerald-500/40 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-emerald-500/50 z-[999] animate-pulse-glow"
        *ngIf="!isOpen" (click)="toggleChat($event)">

        <!-- Dismiss Launcher Button (Visible on hover) -->
        <div class="dismiss-btn-small" (click)="dismissWidget($event)" title="Hide chat">
            <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="relative text-2xl">
            <i class="fa-solid fa-robot"></i>
            <span
                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[11px] font-semibold"
                *ngIf="unreadCount > 0">{{unreadCount}}</span>
        </div>
        <span class="font-bold text-sm tracking-wide hidden md:inline">AI Health Chat</span>
    </div>
</ng-container>

<!-- Chat Window -->
<div class="fixed bottom-16 right-0 w-[80vw] h-[65vh] max-h-[calc(100vh-32px)] bg-white rounded-l-2xl rounded-r-none md:rounded-2xl shadow-2xl flex flex-col overflow-hidden z-[1000] transition-all md:w-[380px] md:h-[600px] md:max-h-[calc(100vh-40px)] md:bottom-5 md:right-5"
    *ngIf="isOpen" @slideUp>

    <!-- Shared Header -->
    <div
        class="bg-gradient-to-br from-emerald-600 to-emerald-800 text-white px-5 py-4 flex justify-between items-center shadow-md shrink-0">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <!-- History Toggle Button (Only for Logged In) -->
            <button type="button" (click)="toggleHistory()" *ngIf="isLoggedIn"
                class="bg-transparent md:bg-white/10 hover:bg-white/20 w-8 h-8 rounded-full shrink-0 transition-all flex items-center justify-center border border-transparent md:border-white/10">
                <i class="fa-solid fa-bars text-xs"></i>
            </button>

            <!-- New Bot Icon -->
            <div
                class="w-10 h-10 rounded-full bg-white/20 border border-white/10 hidden md:flex items-center justify-center shrink-0 backdrop-blur-sm shadow-sm">
                <i class="fa-solid fa-user-doctor text-lg"></i>
            </div>

            <div class="flex flex-col min-w-0 overflow-hidden">
                <h3 class="m-0 text-[15px] font-bold tracking-tight truncate">Health Assistant</h3>
                <div class="flex items-center gap-1.5 opacity-90">
                    <span class="w-1.5 h-1.5 bg-emerald-300 rounded-full shadow-[0_0_8px_rgba(110,231,183,0.8)]"
                        [ngClass]="{'animate-pulse': isWaitingForResponse}"></span>

                    <p class="m-0 text-[10px] font-medium uppercase tracking-wider truncate">
                        <span *ngIf="isWaitingForResponse">Thinking...</span>
                        <span *ngIf="!isWaitingForResponse">
                            <span *ngIf="isLoggedIn && remainingMessages !== 'unlimited'">{{remainingMessages}}
                                Left</span>
                            <span *ngIf="isLoggedIn && remainingMessages === 'unlimited'">Premium</span>
                            <span *ngIf="!isLoggedIn">Guest</span>
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button type="button"
                class="bg-red-500/20 hover:bg-red-500/40 text-white w-8 h-8 rounded-full transition-all flex items-center justify-center shadow-inner"
                *ngIf="isWaitingForResponse" (click)="stopResponse()" title="Stop response">
                <i class="fa-solid fa-stop text-xs"></i>
            </button>
            <button type="button"
                class="bg-transparent md:bg-white/10 hover:bg-white/20 text-white w-8 h-8 rounded-full transition-all flex items-center justify-center"
                (click)="minimizeChat($event)">
                <i class="fa-solid fa-minus text-xs"></i>
            </button>
            <button type="button"
                class="bg-transparent md:bg-white/10 hover:bg-white/20 text-white w-8 h-8 rounded-full transition-all flex items-center justify-center"
                (click)="toggleChat($event)">
                <i class="fa-solid fa-times text-xs"></i>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden relative">
        <ng-container *ngIf="isLoggedIn; else guestPrompt">
            <!-- Sidebar for Chat History (Overlay) -->
            <div class="absolute top-0 left-0 h-full bg-white border-r border-slate-200 transition-all duration-300 overflow-y-auto custom-scrollbar shadow-2xl z-20"
                [ngClass]="showHistory ? 'w-[200px] md:w-64' : 'w-0'">
                <div class="p-4 min-w-0 md:min-w-[16rem]" *ngIf="showHistory">
                    <!-- New Chat Button -->
                    <button (click)="startNewChat()"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-2 md:px-4 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 mb-4">
                        <i class="fa-solid fa-plus text-sm"></i>
                        <span class="text-sm">New Chat</span>
                    </button>

                    <!-- Search Bar -->
                    <div class="relative mb-4">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" [(ngModel)]="historySearchQuery" placeholder="Search chats..."
                            class="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-medium focus:outline-none focus:border-emerald-500 transition-all">
                        <button *ngIf="historySearchQuery" (click)="historySearchQuery = ''"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500">
                            <i class="fa-solid fa-circle-xmark text-xs"></i>
                        </button>
                    </div>

                    <!-- Sessions List -->
                    <div class="flex flex-col gap-1 md:gap-2">
                        <div *ngIf="loadingSessions" class="text-center text-slate-400 text-xs py-8">
                            <i class="fa-solid fa-spinner fa-spin text-lg"></i>
                            <p class="mt-2">Loading chats...</p>
                        </div>

                        <div *ngIf="!loadingSessions && filteredSessions.length === 0"
                            class="text-center text-slate-400 text-xs py-8">
                            <i class="fa-solid fa-comments text-2xl mb-2"></i>
                            <p>{{ historySearchQuery ? 'No matches found' : 'No chats yet' }}</p>
                        </div>

                        <div *ngFor="let session of filteredSessions; let i = index" (click)="switchToSession(session)"
                            class="px-2 pt-1.5 pb-0 md:p-2.5 rounded-lg border border-slate-200 cursor-pointer transition-all hover:bg-emerald-50 hover:border-emerald-300 group relative"
                            [ngClass]="{'bg-emerald-50 border-emerald-400': session.sessionId === currentSessionId}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0 ml-1">
                                    <p
                                        class="text-xs font-semibold text-slate-800 m-0 truncate flex items-center gap-1">
                                        <i *ngIf="session.pinned"
                                            class="fa-solid fa-thumbtack text-[10px] text-emerald-600"></i>
                                        {{session.firstMessage}}
                                    </p>
                                    <p class="text-[10px] text-slate-400 m-0 mt-0.5">
                                        {{getRelativeTime(session.lastMessageAt)}}
                                    </p>
                                </div>
                                <!-- 3-dot menu button -->
                                <div class="relative">
                                    <button (click)="toggleSessionMenu(i, $event)"
                                        class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-slate-700 p-0 -mt-5 md:p-1 md:mt-0">
                                        <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                                    </button>
                                    <!-- Dropdown menu -->
                                    <div *ngIf="activeSessionMenu === i"
                                        class="absolute right-0 top-8 bg-white border border-slate-200 rounded-lg shadow-lg py-1 z-30 min-w-[140px]">
                                        <button (click)="pinSession(session, $event)"
                                            class="w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i class="fa-solid fa-thumbtack text-xs"></i>
                                            {{session.pinned ? 'Unpin' : 'Pin'}}
                                        </button>
                                        <button (click)="renameSession(session, $event)"
                                            class="w-full text-left px-3 py-2 text-xs text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i class="fa-solid fa-pen text-xs"></i>
                                            Rename
                                        </button>
                                        <button (click)="confirmDeleteSession(session, $event)"
                                            class="w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-red-50 flex items-center gap-2">
                                            <i class="fa-solid fa-trash text-xs"></i>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Clear All Button -->
                    <div class="mt-8 pt-4 border-t border-slate-100" *ngIf="chatSessions.length > 0">
                        <button (click)="confirmClearAll()"
                            class="w-full py-2.5 px-4 text-xs font-bold text-red-500 hover:bg-red-50 rounded-xl transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash-can"></i>
                            Clear All History
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex flex-col flex-1 min-w-0" (click)="showHistory = false">
                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 bg-slate-50 flex flex-col gap-4 custom-scrollbar"
                    #messagesContainer>
                    <div *ngFor="let message of messages; let i = index"
                        class="flex gap-3 items-start w-full message-animate"
                        [ngClass]="{'flex-row-reverse': message.sender === 'user'}">

                        <!-- Bot/User Avatar -->
                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 shadow-sm text-sm"
                            [ngClass]="{'bg-emerald-600 text-white': message.sender === 'user', 'bg-white text-emerald-600 border border-emerald-100': message.sender === 'bot'}">
                            <i class="fa-solid" [ngClass]="message.sender === 'bot' ? 'fa-robot' : 'fa-user'"></i>
                        </div>

                        <div class="max-w-[85%] animate-in fade-in slide-in-from-bottom-2 duration-300">
                            <!-- Message Bubble -->
                            <div class="shadow-sm overflow-hidden" [ngClass]="{
                                'bg-emerald-600 text-white rounded-t-2xl rounded-l-2xl rounded-br-[4px]': message.sender === 'user',
                                'bg-white text-slate-800 rounded-t-2xl rounded-r-2xl rounded-bl-[4px] border border-slate-100': message.sender === 'bot' && message.type !== 'UPGRADE_PROMPT'
                            }">

                                <!-- Text Message -->
                                <div *ngIf="message.type !== 'UPGRADE_PROMPT'"
                                    class="px-3.5 py-2.5 leading-relaxed text-[13px] font-medium break-words">
                                    <!-- If Bot: Use formatting (links/HTML) -->
                                    <div *ngIf="message.sender === 'bot'" [innerHTML]="formatMessage(message.text, i)">
                                    </div>

                                    <!-- If User: Just show plain text -->
                                    <div *ngIf="message.sender === 'user'">{{ message.text }}</div>

                                    <!-- Read More / Show Less Button -->
                                    <button *ngIf="message.text.length > 300" (click)="toggleMessage(i)"
                                        class="text-[10px] font-bold text-emerald-600 hover:text-emerald-800 hover:underline mt-1 bg-emerald-50/50 px-2 py-0.5 rounded-full transition-colors">
                                        {{ expandedMessages.has(i) ? 'Show Less' : 'Read More' }}
                                    </button>
                                </div>

                                <!-- Doctor Cards Rendering -->
                                <div *ngIf="message.data?.search_doctors?.doctors?.length"
                                    class="flex flex-col gap-3 mt-3 animate-in fade-in slide-in-from-bottom-2">
                                    <div *ngFor="let doctor of message.data.search_doctors.doctors"
                                        class="bg-slate-50 border border-slate-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex gap-3 cursor-pointer group"
                                        (click)="navigateToFindDoctors(doctor.medicine_type)">
                                        <div
                                            class="w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-white border border-slate-100">
                                            <img [src]="doctor.image || 'assets/default-doctor.png'"
                                                class="w-full h-full object-cover"
                                                onerror="this.src='https://ui-avatars.com/api/?name=' + doctor.name + '&background=random'">
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h5
                                                class="text-xs font-bold text-slate-800 m-0 truncate group-hover:text-emerald-600 transition-colors">
                                                {{doctor.name}}</h5>
                                            <p class="text-[10px] text-emerald-600 font-bold m-0 mt-0.5">
                                                {{doctor.specialization || 'General Physician'}}</p>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span
                                                    class="text-[9px] font-black text-slate-500 bg-slate-200/50 px-1.5 py-0.5 rounded uppercase">{{doctor.medicine_type}}</span>
                                                <span
                                                    class="text-[10px] text-slate-400 font-bold">‚Çπ{{doctor.consultationFee}}</span>
                                            </div>
                                        </div>
                                        <i
                                            class="fa-solid fa-chevron-right text-slate-300 text-[10px] self-center group-hover:translate-x-1 transition-transform"></i>
                                    </div>
                                </div>

                                <!-- Medicine Cards Rendering -->
                                <div *ngIf="message.data?.search_medicines?.medicines?.length"
                                    class="flex flex-col gap-3 mt-3 animate-in fade-in slide-in-from-bottom-2">
                                    <div *ngFor="let med of message.data.search_medicines.medicines"
                                        class="bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all flex gap-3 cursor-pointer group"
                                        (click)="navigateToMedicines()">
                                        <div
                                            class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0 bg-slate-50 border border-slate-100 p-1">
                                            <img [src]="med.image || 'assets/default-medicine.png'"
                                                class="w-full h-full object-contain"
                                                onerror="this.src='https://placehold.co/100x100?text=' + med.name">
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h5
                                                class="text-xs font-bold text-slate-800 m-0 truncate group-hover:text-emerald-600 transition-colors">
                                                {{med.name}}</h5>
                                            <p class="text-[10px] text-slate-500 m-y font-medium mt-0.5 truncate">
                                                {{med.category}}</p>
                                            <div class="flex items-center justify-between mt-1">
                                                <span
                                                    class="text-[11px] font-black text-slate-800">‚Çπ{{med.price}}</span>
                                                <span
                                                    class="text-[9px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded uppercase">{{med.medicine_type
                                                    || 'Herbal'}}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Error message for medicines -->
                                <div *ngIf="message.data?.search_medicines?.error"
                                    class="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded-lg border border-red-100 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                    <span>I couldn't find any medicines matching that description.</span>
                                </div>

                                <!-- Website Features Rendering -->
                                <div *ngIf="message.data?.get_website_features?.features?.length"
                                    class="grid grid-cols-2 gap-2 mt-3 animate-in fade-in slide-in-from-bottom-2">
                                    <div *ngFor="let feature of message.data.get_website_features.features"
                                        class="bg-emerald-50 border border-emerald-100 rounded-xl p-2.5 hover:bg-emerald-100 transition-all cursor-pointer flex flex-col items-center text-center gap-1.5 group"
                                        (click)="navigateToFeature(feature.link)">
                                        <i [class]="'fa-solid fa-' + (feature.icon || 'star')"
                                            class="text-emerald-600 text-sm group-hover:scale-110 transition-transform"></i>
                                        <span
                                            class="text-[10px] font-black text-slate-800 leading-tight">{{feature.name}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Button Options -->
                            <div *ngIf="message.options && message.options.length"
                                class="flex flex-col gap-2 p-3 bg-slate-50/50">
                                <button type="button" *ngFor="let option of message.options"
                                    class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl cursor-pointer text-xs font-bold transition-all text-left hover:bg-emerald-50 hover:border-emerald-500 hover:translate-x-1 shadow-sm"
                                    (click)="selectOption(option)">
                                    {{option.text}}
                                </button>
                            </div>

                            <!-- Upgrade Prompt -->
                            <div *ngIf="message.type === 'UPGRADE_PROMPT'"
                                class="bg-gradient-to-br from-blue-600 to-indigo-700 text-white p-6 rounded-2xl text-center shadow-xl border border-white/20">
                                <div class="text-4xl mb-3 drop-shadow-md">‚≠ê</div>
                                <div class="flex flex-col items-center">
                                    <h4 class="m-0 mb-2 text-lg font-black tracking-tight">Upgrade to Premium</h4>
                                    <p class="m-0 mb-4 text-xs font-bold opacity-90 leading-relaxed">
                                        {{message.upgradeMessage}}
                                    </p>
                                    <div class="mb-4 flex items-baseline gap-1">
                                        <span class="text-3xl font-black">‚Çπ{{message.price}}</span>
                                        <span class="text-xs font-bold opacity-80">/month</span>
                                    </div>
                                    <button type="button"
                                        class="bg-white text-blue-600 px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest transition-all hover:scale-105 hover:shadow-2xl active:scale-95 shadow-lg"
                                        (click)="showPricing()">
                                        View Plans
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Timestamp -->
                        <div class="text-[10px] font-bold text-slate-400 mt-1 px-1"
                            [ngClass]="{'text-right': message.sender === 'user'}">
                            {{message.timestamp | date:'shortTime'}}
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="flex gap-3 items-center" *ngIf="isTyping">
                    <div
                        class="w-8 h-8 rounded-full flex items-center justify-center bg-white text-emerald-600 border border-emerald-100 shadow-sm text-sm">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div
                        class="bg-white px-4 py-3 rounded-t-2xl rounded-r-2xl rounded-bl-[4px] flex gap-1.5 shadow-sm border border-slate-100">
                        <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce [animation-delay:0.2s]"></span>
                        <span class="w-2 h-2 bg-emerald-400 rounded-full animate-bounce [animation-delay:0.4s]"></span>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex-shrink-0 border-t border-slate-200 bg-white p-4 shadow-2xl">
                    <!-- Quick Actions -->
                    <div class="hidden md:flex gap-2 mb-3 overflow-x-auto pb-2 no-scrollbar"
                        *ngIf="showQuickActions && messages.length < 5">
                        <button type="button" *ngFor="let action of quickActions"
                            class="bg-slate-50 border border-slate-200 text-slate-700 px-4 py-2 rounded-full cursor-pointer text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all flex items-center gap-2 hover:bg-emerald-600 hover:text-white hover:border-emerald-600 hover:shadow-lg shadow-sm"
                            (click)="sendQuickAction(action)">
                            <i [class]="action.icon" class="text-[10px]"></i>
                            {{action.label}}
                        </button>
                    </div>

                    <div class="flex gap-2 items-center">
                        <input type="text"
                            class="flex-1 px-4 py-2.5 border-2 border-slate-100 rounded-xl text-sm font-bold placeholder:text-slate-300 outline-none transition-all focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 disabled:bg-slate-50 disabled:cursor-not-allowed shadow-inner"
                            [(ngModel)]="currentMessage" (keyup.enter)="sendMessage()" [disabled]="limitReached"
                            placeholder="{{limitReached ? 'Limit reached - Upgrade to continue' : 'Describe your symptoms...'}}">

                        <button type="button"
                            class="w-10 h-10 bg-emerald-600 text-white border-none rounded-xl cursor-pointer flex items-center justify-center transition-all hover:bg-emerald-700 hover:scale-[1.05] active:scale-95 disabled:bg-slate-200 shadow-lg shadow-emerald-500/20"
                            (click)="sendMessage()" [disabled]="!currentMessage.trim() || limitReached">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>

    <!-- Delete Confirmation Modal (In-Chat Overlay) -->
    <div *ngIf="sessionToDelete"
        class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[50]"
        (click)="cancelDelete()">
        <div class="bg-white rounded-2xl p-6 max-w-[280px] w-full mx-4 shadow-2xl animate-in fade-in zoom-in duration-200"
            (click)="$event.stopPropagation()">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-trash-can text-xl"></i>
            </div>
            <h3 class="text-lg font-black text-slate-800 text-center mb-2">Delete Chat?</h3>
            <p class="text-xs text-slate-500 text-center mb-6 leading-relaxed">
                Are you sure you want to delete <span
                    class="font-bold text-slate-800">"{{sessionToDelete.firstMessage}}"</span>? This cannot be
                undone.
            </p>
            <div class="flex flex-col gap-2">
                <button (click)="executeDelete(); $event.stopPropagation()"
                    class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-red-600/20 transition-all active:scale-95">
                    Delete Chat
                </button>
                <button (click)="cancelDelete(); $event.stopPropagation()"
                    class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Modal (In-Chat Overlay) -->
    <div *ngIf="sessionToRename"
        class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[50]"
        (click)="cancelRename()">
        <div class="bg-white rounded-2xl p-6 max-w-[280px] w-full mx-4 shadow-2xl animate-in fade-in zoom-in duration-200"
            (click)="$event.stopPropagation()">
            <div
                class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-pen-to-square text-xl"></i>
            </div>
            <h3 class="text-lg font-black text-slate-800 text-center mb-4">Rename Chat</h3>
            <input type="text" [(ngModel)]="renameInput" (keyup.enter)="saveRename()" (keyup.escape)="cancelRename()"
                class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-100 rounded-xl text-sm font-bold focus:outline-none focus:border-emerald-500 transition-all mb-6"
                placeholder="Enter new name..." autofocus>
            <div class="flex flex-col gap-2">
                <button (click)="saveRename(); $event.stopPropagation()"
                    class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-emerald-600/20 transition-all active:scale-95"
                    [disabled]="!renameInput.trim()">
                    Save Name
                </button>
                <button (click)="cancelRename(); $event.stopPropagation()"
                    class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Clear All Confirmation Modal (In-Chat Overlay) -->
    <div *ngIf="showClearAllModal"
        class="absolute inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[50]"
        (click)="cancelClearAll()">
        <div class="bg-white rounded-2xl p-6 max-w-[280px] w-full mx-4 shadow-2xl animate-in fade-in zoom-in duration-200"
            (click)="$event.stopPropagation()">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="text-lg font-black text-slate-800 text-center mb-2">Clear History?</h3>
            <p class="text-[11px] text-slate-500 text-center mb-6 leading-relaxed">
                This will <span class="text-red-600 font-bold uppercase italic border-b-2 border-red-200">permanently
                    delete</span> all your previous chats.
                This action <span class="font-bold text-slate-800 underline">cannot be undone</span>.
            </p>
            <div class="flex flex-col gap-2">
                <button (click)="executeClearAll(); $event.stopPropagation()" [disabled]="isClearingAll"
                    class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl text-xs font-black uppercase tracking-widest shadow-lg shadow-red-600/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can" *ngIf="!isClearingAll"></i>
                    <i class="fa-solid fa-spinner fa-spin" *ngIf="isClearingAll"></i>
                    {{ isClearingAll ? 'Clearing...' : 'Clear Everything' }}
                </button>
                <button (click)="cancelClearAll(); $event.stopPropagation()"
                    class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Guest Login Prompt -->
    <ng-template #guestPrompt>
        <div
            class="flex-1 flex flex-col items-center justify-center p-8 text-center bg-slate-50 relative overflow-hidden">
            <!-- Decorative blurred circles -->
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-emerald-500/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-emerald-500/10 rounded-full blur-3xl"></div>

            <div class="relative z-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <!-- <div
                    class="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center text-5xl mb-6 mx-auto border border-emerald-50/50">
                    ü§ñ
                </div> -->

                <h3 class="text-2xl font-black text-slate-800 mb-3 tracking-tight">Your Health Companion</h3>
                <p class="text-[13px] text-slate-500 font-medium leading-relaxed mb-8 max-w-[240px] mx-auto">
                    Sign in to get personalized health advice, search for doctors, and manage your medical history.
                </p>

                <div class="flex flex-col gap-3 w-full max-w-[200px] mx-auto">
                    <button (click)="isOpen = false; router.navigate(['/login'])"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-3.5 rounded-2xl shadow-lg shadow-emerald-600/20 transition-all hover:scale-[1.02] active:scale-95 text-xs uppercase tracking-widest">
                        Sign In
                    </button>
                    <button (click)="isOpen = false; router.navigate(['/register'])"
                        class="w-full bg-white border-2 border-slate-200 text-slate-700 hover:border-emerald-500 hover:text-emerald-600 font-extrabold py-3.5 rounded-2xl transition-all text-xs uppercase tracking-widest">
                        Join Now
                    </button>
                </div>

                <p class="mt-8 text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                    Safe ‚Ä¢ Secure ‚Ä¢ Private
                </p>
            </div>
        </div>
    </ng-template>
</div>