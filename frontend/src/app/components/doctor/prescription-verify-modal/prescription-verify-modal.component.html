<!-- Modal Overlay -->
<div class="fixed inset-0 z-50 overflow-y-auto bg-black/50 backdrop-blur-sm" (click)="closeModal()">
    <div class="flex min-h-full items-center justify-center p-4">
        <div (click)="$event.stopPropagation()"
            class="relative w-full max-w-6xl bg-white rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">

            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-file-medical text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">Prescription Verification</h3>
                            <p class="text-xs text-emerald-100">Review and verify prescription document</p>
                        </div>
                    </div>
                    <button (click)="closeModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fa-solid fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div *ngIf="loading" class="p-8 text-center">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-emerald-600 mb-3"></i>
                <p class="text-gray-600">Loading prescription details...</p>
            </div>

            <!-- Content -->
            <div *ngIf="!loading && prescriptionDetails" class="flex-1 overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">

                    <!-- Left Column: Prescription File Viewer -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl border-2 border-gray-200 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-900 flex items-center gap-2">
                                    <i class="fa-solid fa-file text-emerald-600"></i>
                                    Prescription Document
                                </h4>
                                <button (click)="downloadPrescription()"
                                    class="px-3 py-1 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded-lg text-sm font-medium transition-colors">
                                    <i class="fa-solid fa-download"></i> Download
                                </button>
                            </div>

                            <!-- PDF Viewer -->
                            <div *ngIf="fileType === 'pdf'" class="bg-white rounded-lg overflow-hidden">
                                <embed [src]="prescriptionFileUrl" type="application/pdf" class="w-full h-[500px]">
                            </div>

                            <!-- Image Viewer -->
                            <div *ngIf="fileType === 'image'" class="bg-white rounded-lg overflow-hidden">
                                <img [src]="prescriptionFileUrl" alt="Prescription"
                                    class="w-full h-auto max-h-[500px] object-contain">
                            </div>

                            <!-- Unknown File Type -->
                            <div *ngIf="fileType === 'unknown'" class="bg-gray-100 rounded-lg p-8 text-center">
                                <i class="fa-solid fa-file text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">Preview not available</p>
                                <button (click)="downloadPrescription()"
                                    class="mt-3 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium">
                                    Download File
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Details -->
                    <div class="space-y-4">

                        <!-- Patient Info -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-user-md"></i>
                                Patient Information
                            </h4>
                            <div class="space-y-2">
                                <div>
                                    <p class="text-xs text-blue-700 font-semibold">Name</p>
                                    <p class="text-sm text-blue-900">{{ prescriptionDetails.patient_name }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-blue-700 font-semibold">Email</p>
                                    <p class="text-sm text-blue-900">{{ prescriptionDetails.patient_email }}</p>
                                </div>
                                <div *ngIf="prescriptionDetails.patient_phone">
                                    <p class="text-xs text-blue-700 font-semibold">Phone</p>
                                    <p class="text-sm text-blue-900">{{ prescriptionDetails.patient_phone }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Prescription Details -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <h4 class="font-bold text-green-900 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-prescription"></i>
                                Prescription Details
                            </h4>
                            <div class="space-y-2 mb-3">
                                <div>
                                    <p class="text-xs text-green-700 font-semibold">Upload Date</p>
                                    <p class="text-sm text-green-900">{{ prescriptionDetails.created_at | date:'MMM d, y
                                        h:mm a' }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-green-700 font-semibold">Issue Date</p>
                                    <p class="text-sm text-green-900">{{ prescriptionDetails.issue_date | date:'MMM d,
                                        y' }}</p>
                                </div>
                                <div *ngIf="prescriptionDetails.expiry_date">
                                    <p class="text-xs text-green-700 font-semibold">Expiry Date</p>
                                    <p class="text-sm text-green-900">{{ prescriptionDetails.expiry_date | date:'MMM d,
                                        y' }}</p>
                                </div>
                                <div *ngIf="prescriptionDetails.notes">
                                    <p class="text-xs text-green-700 font-semibold">Notes</p>
                                    <p class="text-sm text-green-900">{{ prescriptionDetails.notes }}</p>
                                </div>
                            </div>

                            <!-- Medicines -->
                            <div *ngIf="prescriptionDetails.medicines && prescriptionDetails.medicines.length > 0">
                                <p class="text-xs text-green-700 font-semibold mb-2">Medicines:</p>
                                <div class="space-y-2">
                                    <div *ngFor="let medicine of prescriptionDetails.medicines; let i = index"
                                        class="bg-white border border-green-200 rounded-lg p-2">
                                        <div class="flex items-start gap-2">
                                            <span
                                                class="w-5 h-5 bg-green-200 rounded-full flex items-center justify-center text-xs font-bold text-green-800">
                                                {{ i + 1 }}
                                            </span>
                                            <div class="flex-1">
                                                <p class="font-semibold text-sm text-green-900">{{
                                                    medicine.medicine_name }}</p>
                                                <div class="grid grid-cols-2 gap-1 mt-1 text-xs text-green-700">
                                                    <p *ngIf="medicine.dosage"><i
                                                            class="fa-solid fa-prescription-bottle"></i> {{
                                                        medicine.dosage }}</p>
                                                    <p *ngIf="medicine.frequency"><i class="fa-solid fa-clock"></i> {{
                                                        medicine.frequency }}</p>
                                                    <p *ngIf="medicine.duration"><i class="fa-solid fa-calendar"></i> {{
                                                        medicine.duration }}</p>
                                                    <p *ngIf="medicine.quantity"><i class="fa-solid fa-pills"></i> {{
                                                        medicine.quantity }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Forms -->
                        <div *ngIf="prescriptionDetails.status === 'pending'">

                            <!-- Verify Form -->
                            <div *ngIf="showVerifyForm" class="bg-green-50 border border-green-200 rounded-xl p-4">
                                <h5 class="font-bold text-green-900 mb-3">Verify Prescription</h5>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-green-800 mb-2">Verification Notes
                                        (Optional)</label>
                                    <textarea [(ngModel)]="verificationNotes" rows="3"
                                        class="w-full px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
                                        placeholder="Add any notes about this prescription..."></textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button (click)="confirmVerify()"
                                        class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                                        <i class="fa-solid fa-check"></i> Confirm Verification
                                    </button>
                                    <button (click)="closeForms()"
                                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- Reject Form -->
                            <div *ngIf="showRejectForm" class="bg-red-50 border border-red-200 rounded-xl p-4">
                                <h5 class="font-bold text-red-900 mb-3">Reject Prescription</h5>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-red-800 mb-2">Rejection Reason
                                        *</label>
                                    <textarea [(ngModel)]="rejectionReason" rows="3"
                                        class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm"
                                        placeholder="Please provide a detailed reason (minimum 20 characters)..."></textarea>
                                    <p class="text-xs text-red-600 mt-1">{{ rejectionReason.length }} / 20 minimum</p>
                                </div>
                                <div class="flex gap-2">
                                    <button (click)="confirmReject()"
                                        class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
                                        <i class="fa-solid fa-times"></i> Confirm Rejection
                                    </button>
                                    <button (click)="closeForms()"
                                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div *ngIf="!loading && prescriptionDetails && prescriptionDetails.status === 'pending' && !showVerifyForm && !showRejectForm"
                class="border-t border-gray-200 px-6 py-4 bg-gray-50">
                <div class="flex gap-3">
                    <button (click)="openVerifyForm()"
                        class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i>
                        Verify Prescription
                    </button>
                    <button (click)="openRejectForm()"
                        class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times-circle"></i>
                        Reject Prescription
                    </button>
                    <button (click)="closeModal()"
                        class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all">
                        Close
                    </button>
                </div>
            </div>

            <!-- Already Processed -->
            <div *ngIf="!loading && prescriptionDetails && prescriptionDetails.status !== 'pending'"
                class="border-t border-gray-200 px-6 py-4 bg-gray-50">
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">This prescription has already been processed</p>
                    <span class="inline-block px-4 py-2 rounded-full font-semibold"
                        [class.bg-green-100]="prescriptionDetails.status === 'verified'"
                        [class.text-green-800]="prescriptionDetails.status === 'verified'"
                        [class.bg-red-100]="prescriptionDetails.status === 'rejected'"
                        [class.text-red-800]="prescriptionDetails.status === 'rejected'">
                        {{ prescriptionDetails.status | titlecase }}
                    </span>
                </div>
            </div>

        </div>
    </div>
</div>