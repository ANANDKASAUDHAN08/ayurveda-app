<!-- Modal Overlay -->
<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" (click)="closeModal()"></div>

    <!-- Modal Panel -->
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative w-full max-w-4xl bg-white rounded-2xl shadow-xl" (click)="$event.stopPropagation()">

            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-file-medical text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white" id="modal-title">Refill Request Review</h3>
                            <p class="text-xs text-emerald-100">Review patient details and prescription history</p>
                        </div>
                    </div>
                    <button (click)="closeModal()" class="text-white/80 hover:text-white transition-colors">
                        <i class="fa-solid fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div *ngIf="loading" class="p-8 text-center">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-emerald-600 mb-3"></i>
                <p class="text-gray-600">Loading details...</p>
            </div>

            <!-- Content -->
            <div *ngIf="!loading && refillDetails" class="p-6 max-h-[70vh] overflow-y-auto">

                <!-- Patient Info Card -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                    <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user-md"></i>
                        Patient Information
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-xs text-blue-700 mb-1">Name</p>
                            <p class="font-medium text-blue-900">{{ refillDetails.patient_name }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-blue-700 mb-1">Email</p>
                            <p class="font-medium text-blue-900">{{ refillDetails.patient_email }}</p>
                        </div>
                        <div *ngIf="refillDetails.patient_phone">
                            <p class="text-xs text-blue-700 mb-1">Phone</p>
                            <p class="font-medium text-blue-900">{{ refillDetails.patient_phone }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-blue-700 mb-1">Total Prescriptions</p>
                            <p class="font-medium text-blue-900">{{ refillDetails.patient_prescription_count }}</p>
                        </div>
                    </div>
                </div>

                <!-- Refill Request Details -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                    <h4 class="font-bold text-yellow-900 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-file-alt"></i>
                        Refill Request Details
                    </h4>
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs text-yellow-700 mb-1">Requested On</p>
                            <p class="font-medium text-yellow-900">{{ refillDetails.requested_at | date:'MMM d, y h:mm
                                a' }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-yellow-700 mb-1">Reason for Refill</p>
                            <p class="font-medium text-yellow-900">{{ refillDetails.reason }}</p>
                        </div>
                        <div *ngIf="refillDetails.preferred_pharmacy">
                            <p class="text-xs text-yellow-700 mb-1">Preferred Pharmacy</p>
                            <p class="font-medium text-yellow-900">
                                <i class="fa-solid fa-store text-yellow-700"></i>
                                {{ refillDetails.preferred_pharmacy }}
                            </p>
                        </div>
                        <div *ngIf="refillDetails.patient_notes">
                            <p class="text-xs text-yellow-700 mb-1">Patient Notes</p>
                            <p class="font-medium text-yellow-900">{{ refillDetails.patient_notes }}</p>
                        </div>
                    </div>
                </div>

                <!-- Original Prescription -->
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4">
                    <h4 class="font-bold text-green-900 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-prescription"></i>
                        Original Prescription
                    </h4>
                    <div class="space-y-2 mb-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <p class="text-xs text-green-700 mb-1">Issue Date</p>
                                <p class="font-medium text-green-900">{{ refillDetails.issue_date | date:'MMM d, y' }}
                                </p>
                            </div>
                            <div *ngIf="refillDetails.expiry_date">
                                <p class="text-xs text-green-700 mb-1">Expiry Date</p>
                                <p class="font-medium text-green-900">{{ refillDetails.expiry_date | date:'MMM d, y' }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Medicines List -->
                    <div>
                        <p class="text-xs text-green-700 mb-2 font-semibold">Medicines:</p>
                        <div class="space-y-2">
                            <div *ngFor="let medicine of refillDetails.medicines; let i = index"
                                class="bg-white border border-green-200 rounded-lg p-3">
                                <div class="flex items-start gap-2">
                                    <span
                                        class="w-6 h-6 bg-green-200 rounded-full flex items-center justify-center text-xs font-bold text-green-800">
                                        {{ i + 1 }}
                                    </span>
                                    <div class="flex-1">
                                        <p class="font-semibold text-green-900">{{ medicine.medicine_name }}</p>
                                        <div class="grid grid-cols-2 gap-2 mt-1 text-xs text-green-700">
                                            <p *ngIf="medicine.dosage">
                                                <i class="fa-solid fa-prescription-bottle"></i> {{ medicine.dosage }}
                                            </p>
                                            <p *ngIf="medicine.frequency">
                                                <i class="fa-solid fa-clock"></i> {{ medicine.frequency }}
                                            </p>
                                            <p *ngIf="medicine.duration">
                                                <i class="fa-solid fa-calendar"></i> {{ medicine.duration }}
                                            </p>
                                            <p *ngIf="medicine.quantity">
                                                <i class="fa-solid fa-pills"></i> Qty: {{ medicine.quantity }}
                                            </p>
                                        </div>
                                        <p *ngIf="medicine.instructions" class="text-xs text-green-600 mt-1">
                                            {{ medicine.instructions }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Refill History -->
                <div *ngIf="refillDetails.patient_refill_history && refillDetails.patient_refill_history.length > 0"
                    class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-4">
                    <h4 class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-history"></i>
                        Patient's Refill History
                    </h4>
                    <div class="space-y-2">
                        <div *ngFor="let history of refillDetails.patient_refill_history"
                            class="bg-white border border-purple-200 rounded-lg p-2">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-purple-900 font-medium">
                                        {{ history.requested_at | date:'MMM d, y' }}
                                    </p>
                                    <p class="text-xs text-purple-700">{{ history.reason }}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full font-medium"
                                    [class.bg-green-100]="history.status === 'approved'"
                                    [class.text-green-800]="history.status === 'approved'"
                                    [class.bg-red-100]="history.status === 'rejected'"
                                    [class.text-red-800]="history.status === 'rejected'"
                                    [class.bg-yellow-100]="history.status === 'pending'"
                                    [class.text-yellow-800]="history.status === 'pending'">
                                    {{ history.status | titlecase }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Forms -->
                <div *ngIf="refillDetails.status === 'pending'" class="mb-4">
                    <!-- Approve Form -->
                    <div *ngIf="showApproveForm" class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <h5 class="font-bold text-green-900 mb-3">Approve Refill Request</h5>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-green-800 mb-2">Doctor's Notes
                                (Optional)</label>
                            <textarea [(ngModel)]="doctorNotes" rows="3"
                                class="w-full px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Add any notes for the patient..."></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button (click)="confirmApprove()"
                                class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                                <i class="fa-solid fa-check"></i>
                                Confirm Approval
                            </button>
                            <button (click)="closeForms()"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Reject Form -->
                    <div *ngIf="showRejectForm" class="bg-red-50 border border-red-200 rounded-xl p-4">
                        <h5 class="font-bold text-red-900 mb-3">Reject Refill Request</h5>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-red-800 mb-2">Rejection Reason *</label>
                            <textarea [(ngModel)]="rejectionReason" rows="3"
                                class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                placeholder="Please provide a reason (minimum 10 characters)..."></textarea>
                            <p class="text-xs text-red-600 mt-1">{{ rejectionReason.length }} / 10 minimum</p>
                        </div>
                        <div class="flex gap-2">
                            <button (click)="confirmReject()"
                                class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">
                                <i class="fa-solid fa-times"></i>
                                Confirm Rejection
                            </button>
                            <button (click)="closeForms()"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div *ngIf="!loading && refillDetails && refillDetails.status === 'pending' && !showApproveForm && !showRejectForm"
                class="border-t border-gray-200 px-6 py-4 bg-gray-50 rounded-b-2xl">
                <div class="flex gap-3">
                    <button (click)="openApproveForm()"
                        class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check-circle"></i>
                        Approve Refill
                    </button>
                    <button (click)="openRejectForm()"
                        class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times-circle"></i>
                        Reject Refill
                    </button>
                    <button (click)="closeModal()"
                        class="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all">
                        Close
                    </button>
                </div>
            </div>

            <!-- Status Display (for non-pending refills) -->
            <div *ngIf="!loading && refillDetails && refillDetails.status !== 'pending'"
                class="border-t border-gray-200 px-6 py-4 bg-gray-50 rounded-b-2xl">
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">This refill has already been processed</p>
                    <span class="inline-block px-4 py-2 rounded-full font-semibold"
                        [class.bg-green-100]="refillDetails.status === 'approved'"
                        [class.text-green-800]="refillDetails.status === 'approved'"
                        [class.bg-red-100]="refillDetails.status === 'rejected'"
                        [class.text-red-800]="refillDetails.status === 'rejected'">
                        {{ refillDetails.status | titlecase }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>